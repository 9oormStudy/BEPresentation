# 📚️ 트랜잭션 ACID
트랜잭션의 안전성을 보장하기 위해 필요한 4가지 성질

.
## 📕 A. 원자성 <sup>Atomicity</sup>
하나의 트랜잭션 내 작업은  
`commit` 모두 성공 하거나   
`roll back` 모두 실패 하여야 한다. 

### 📄 원자성 위반 예시
아래 작업들은 함께 성공해야 하며,  
어느 하나만 성공해서는 안 된다.  
차라리 둘 다 실패해야 한다.  
- 계좌 A에서 금액을 차감
- 계좌 B에 금액을 추가

.
## 📙 C. 일관성 <sup>Consistency</sup>
모든 트랜잭션은 일관성 있는 DB 상태를 유지해야 한다. 

데이터베이스의 제약 조건을 준수하여야 한다.

### 📄 일관성 위반 예시
`계좌는 주인이 있어야 한다.`라는 규칙을 정하였을 때,  
아래 작업들을 해당 조건을 위반한다.  
- 계좌에서 명의를 삭제
- 주인이 없는 계좌를 생성

.
## 📗 I. 격리성, 고립성 <sup>Isolation</sup>
동시에 실행되는 트랜잭션은 서로 독립적이어야 한다.

### 📄 더티 리드 <sup>Dirty Read</sup>
한 트랜잭션이 아직 커밋되지 않은 데이터를 읽는 현상  

A가 커밋되지 않은 상태에서,  
B가 변경된 데이터를 읽는 경우,  
A가 롤백된다면,  
B는 실제로 존재하지 않는 데이터를 읽게 된다.  

```
잔액 : 1000원  
🔴 : 1000원 출금 후 `roll back`  
🔵 : 계좌 잔액 조회  
```

- 더티 리드
  - 🔴 1000원 출금 👉 잔액 : 0원
  - 🔵 계좌 잔액 조회 👉 잔액 : 0원
  - 🔴 `roll back` 👉 잔액 : 1000원

- 올바른 순서
  - 🔴 출금 👉 잔액 : 0원
  - 🔴 `roll back` 👉 잔액 : 1000원
  - 🔵 조회 👉 잔액 : 1000원

### 📄 논리적 리드 <sup>Non-repeatable Read</sup>
한 트랜잭션 내에서 같은 데이터를 여러 번 조회할 때,  
조회 결과가 다르게 나타나는 현상  

A가 데이터를 조회 후,  
B가 데이터를 변경하고 커밋한다면,  
A가 다시 조회했을 때,  
일관되지 않는 값을 얻게 된다.  

```
잔액 : 2000원  
🔴 : 1000원 출금 후 `commit`  
🔵 : 계좌 잔액 조회, 1000원 출금, 계좌 잔액 검증
```

- 논리적 리드
  - 🔵 계좌 잔액 조회 👉 잔액 : 2000원
  - 🔵 1000원 출금 👉 잔액 : 1000원
  - 🔴 1000원 출금 후 `commit` 👉 잔액 : 0원
  - 🔵 계좌 잔액 검증 👉 기대 잔액 : 1000원, 실제 잔액 : 0원 👉 불일치
  - 🔵 `roll back`

- 올바른 순서
  - 🔴 1000원 출금 후 `commit` 👉 잔액 : 1000원
  - 🔵 계좌 잔액 조회 👉 잔액 : 1000원
  - 🔵 1000원 출금 👉 잔액 : 0원
  - 🔵 계좌 잔액 검증 👉 기대 잔액 : 0원, 실제 잔액 : 0원 👉 일치
  - 🔵 `commit`

### 📄 팬텀 리드 <sup>Phantom Read</sup>
한 트랜잭션 내에서 동일한 쿼리를 반복 실행했을 때,  
쿼리의 결과 집합이 다르게 나타나는 현상  

```
계좌 A 잔액 : 10000원
계좌 B 잔액 : 8000원
계좌 C 잔액 : 6000원
계좌 D 잔액 : 4000원
계좌 E 잔액 : 2000원

🔴 : 20000원을 보유한 계좌 F를 추가 후 `commit`  
🔵 : 5000원 이상을 보유 중인 계좌 조회 반복
```

- 팬텀 리드
  - 🔵 계좌 조회 👉 A, B, C
  - 🔴 계좌 F를 추가, `commit` 
  - 🔵 계좌 조회 👉 A, B, C, F
  
- 올바른 순서
  - 🔵 계좌 조회 👉 A, B, C
  - 🔵 계좌 조회 👉 A, B, C
  - 🔴 계좌 F를 추가, `commit` 

### 📑 격리 수준
모든 트랜잭션을 요청의 순서대로 처리하면 격리성 문제는 해결될 수 있지만,  
동시에 처리할 수 있는 부분은 동시에 처리한다면 처리 속도를 향상시킬 수 있다.  
👉 `격리성` 과 `동시성` 사이의 `trade-off`

이를 위해 격리 수준을 명시할 수 있다.  

- **READ UNCOMMITED** <sup>커밋되지 않은 읽기</sup> 
  - 가장 낮은 격리 수준
  - ⭕ `더티 리드` 허용
  - ⭕ `논리적 리드` 허용
  - ⭕ `팬텀 리드` 허용
- **READ COMMITED** <sup>커밋된 읽기</sup> 
  - ❌️ `더티 리드` 방지
  - ⭕ `논리적 리드` 허용
  - ⭕ `팬텀 리드` 허용
- **REPEATABLE READ** <sup>반복 가능한 읽기</sup> 
  - ❌️ `더티 리드` 방지
  - ❌️ `논리적 리드` 방지
  - ⭕ `팬텀 리드` 허용
- **SERIALIZABLE** <sup>직렬화 가능</sup> 
  - 가장 높은 격리 수준
  - ❌️ `더티 리드` 방지
  - ❌️ `논리적 리드` 방지
  - ❌️ `팬텀 리드` 방지
  - 모든 트랜잭션이 순차적으로 실행

.
## 📘 D. 지속성 <sup>Durability</sup>
트랜잭션이 성공적으로 끝나면 결과가 항상 기록되어야 한다.

트랜잭션이 성공적으로 완료되면,  
그 결과가 영구적으로 저장되고,  
그 과정에서 발생한 모든 변경 사항이 안정적으로 기록되어야 한다.  

로그 파일은 시스템이 다운되더라도 안전하게 보관되어야 한다.

### 📄 지속성 위반 예시

고객이 입금을 시도하였고,  
입금이 완료되었다는 응답을 보냈는데,  
얘기치 못한 DB 서버의 장애로 인해,  
실제로 DB에 적용이 되지 않은 경우,  
해당 금액은 단지 사라져 버린다.

만약 해당 과정이 기록되지 않았다면, 복구조차 할 수 없게 된다.  